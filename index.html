<!DOCTYPE html>
<html lang = "en">
<head>
    <meta charset = "UTF-8">
    <title>United States House Price Index Map</title>
    <link rel="stylesheet" href="style.css" type="text/css">
    <!-- Bootstrap, D3, ajax -->  
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script>
         // Global variables
         var year = 2022;
         var csvData;
         var type_filter = "traditional";
         var index_filter = "index_nsa";
         var flavor_filter = "all-transactions";
         var curr_selection;
        // Load JSON into SVG
        function loadMap(mapName){
            $.getJSON('json/' + mapName + '.json', function(data){
                const col = document.getElementById("left-col");
                const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
                svg.setAttribute("id", "us-map");
                svg.setAttribute("width", data.width);
                svg.setAttribute("height", data.height);  
                svg.setAttribute("viewBox", data.viewBox);
                const g = document.createElementNS("http://www.w3.org/2000/svg","g");
                for(var state of Object.keys(data.states)){
                     const state_g = document.createElementNS("http://www.w3.org/2000/svg","g");
                     state_g.setAttribute("id", "state");
                     state_g.setAttribute("state-name", state);
                     state_g.setAttribute("view", data.states[state]["viewBox"]);
                     for(var counties of Object.keys(data.states[state]["counties"])){
                        const county_path = document.createElementNS("http://www.w3.org/2000/svg","path");
                        county_path.setAttribute("id", "county");
                        county_path.setAttribute("county-name", counties);
                        county_path.setAttribute("d", data.states[state]["counties"][counties]);
                        state_g.appendChild(county_path);
                    }
                    g.appendChild(state_g);                 
                }
                const border = document.createElementNS("http://www.w3.org/2000/svg","g");
                const border_path = document.createElementNS("http://www.w3.org/2000/svg","path");
                border.setAttribute("id", "border");
                border_path.setAttribute("d", data.border);
                border_path.style.stroke = "black";
                border_path.style.strokeWidth = ".89143px";
                border_path.style.fill = "none";
                border.appendChild(border_path);
                svg.appendChild(g);
                svg.appendChild(border);
                col.appendChild(svg);
            });
        };
        // Read dataset CSV
        Promise.all([
            d3.csv('datasets/states_cleaned_data.csv')
        ]).then(ready);

        // Assign all the values and create all the functions
        function ready(data){
            curr_selection = "us";
            //Gloval Variables
            let allowhover = true;
            var statename; 
            csvData = data;
            display_color(data);
            // Mouse hover over state show status
            document.addEventListener('mouseover', function(event){
                if(allowhover){
                    var target = event.target.parentElement;
                    if(target.id == "state"){
                        if(statename != undefined){
                           change_color(data, statename);
                        }
                        statename = target.getAttribute("state-name");
                        target.style.cssText += 'fill: #FFFAA0;';
                        document.getElementById('displayName').innerHTML = "<strong>States: </strong>" + statename;
                        var result = data[0].filter(obj => {
                        return obj["state"] === statename && obj["year"] == year && obj["type"] == type_filter && obj["index type"] == index_filter && obj["flavor"] == flavor_filter;
                        });
                        display_hist(data, statename);
                        document.getElementById('currentIdx').innerHTML = "<strong>Current: </strong>" + result[0]["index"];
                    }
                    else{
                        display_color(data);
                        document.getElementById('displayName').innerHTML = "<strong>States: </strong>";
                        document.getElementById('currentIdx').innerHTML = "<strong>Current: </strong>";
                        document.getElementById('hisMax').innerHTML = "<strong>Max: </strong>";
                        document.getElementById('hisMin').innerHTML = "<strong>Min: </strong>";
                    }
                }
            });

            // Click state freeze status and zoom in
            document.addEventListener('click', function(event){
                var target = event.target.parentElement;
                if(target.id == "state"){
                     statename = target.getAttribute("state-name");
                     tonedown_color(data, statename);
                     //target.style.cssText += 'fill: #93C572;';
                     var result = data[0].filter(obj => {
                           return obj["state"] == statename && obj["year"] == year && obj["type"] == type_filter && obj["index type"] == index_filter && obj["flavor"] == flavor_filter;
                     });
                     display_hist(data, statename);
                     document.getElementById('currentIdx').innerHTML = "<strong>Current: </strong>" + result[0]["index"];
                     document.getElementById('displayName').innerHTML = "<strong>States: </strong>" + statename;
                     allowhover = false;
                     // Zoom in
                     var svg = document.getElementById("us-map");
                     var animation = document.createElementNS("http://www.w3.org/2000/svg","animate");
                     svg.setAttribute("viewBox", target.getAttribute("view"));
                     curr_selection = "state";
                }
            }); 
            document.getElementById("clearbtn").onclick = function(){clear()};
            function clear(){
               var states = document.querySelectorAll("[id^='state']");
               for (var i = 0; i < states.length; i++){
                     states[i].style.fill = "";
               }
               allowhover = true;
               document.getElementById('displayName').innerHTML = "<strong>States: </strong>";
               document.getElementById('currentIdx').innerHTML = "<strong>Current: </strong>";
               document.getElementById('hisMax').innerHTML = "<strong>Max: </strong>";
               document.getElementById('hisMin').innerHTML = "<strong>Min: </strong>";

               display_color(csvData);
               var svg = document.getElementById("us-map");
               svg.setAttribute("viewBox", "0 0 989.98 627.07");
               curr_selection = "us";
            };
         };
       
         // Display color for each state
         function display_color(data){
            var states = data[0].filter(state => {
                  return state["year"] == year && state["type"] == type_filter && state["index type"] == index_filter && state["flavor"] == flavor_filter;
               });
            var max = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
            });
            var min = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
            });
            var range = max["index"] - min["index"];
            document.getElementById('min-value-p').innerHTML = min['index'];
            document.getElementById('max-value-p').innerHTML = max['index'];
            for(var i = 0; i < states.length; i++){
               var ratio = (states[i]["index"] - min["index"]) / range;
               // Predefined RGB color scale
               // Red = 222 - 100
               // Green = 149 - 49
               // Blue = 237 - 99
               var red = 100 + (222 - 100) * ratio;
               var green = 149 - (149 - 49) * ratio;
               var blue = 237 - (237 - 99) * ratio;
               var color = "rgb(" + red + "," + green + "," + blue + ")";
               document.querySelector('[state-name="' + states[i]["state"] + '"]').style.cssText += 'fill: ' + color + ';';
            }
         };

         function change_color(data, statename){
            var states = data[0].filter(state => {
               return state["year"] == year && state["type"] == type_filter && state["index type"] == index_filter && state["flavor"] == flavor_filter;
            });
            var max = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
            });
            var min = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
            });
            var range = max["index"] - min["index"];
            var state = states.filter(state => {
               return state["state"] == statename;
            });
            document.getElementById('min-value-p').innerHTML = min['index'];
            document.getElementById('max-value-p').innerHTML = max['index'];
            var ratio = (state[0]["index"] - min["index"]) / range;
            var red = 100 + (222 - 100) * ratio;
            var green = 149 - (149 - 49) * ratio;
            var blue = 237 - (237 - 99) * ratio;
            var color = "rgb(" + red + "," + green + "," + blue + ")";
            var result = data[0].filter(obj => {
                  return obj["state"] == statename && obj["year"] == year && obj["type"] == type_filter && obj["index type"] == index_filter && obj["flavor"] == flavor_filter;
            });
            document.getElementById('currentIdx').innerHTML = "<strong>Current: </strong>" + result[0]["index"];
            document.querySelector('[state-name="' + statename + '"]').style.cssText += 'fill: ' + color + ';';
         }

         // Tone down other state color
         function tonedown_color(data, statename){
            var states = data[0].filter(state => {
                  return state["year"] == year && state["type"] == type_filter && state["index type"] == index_filter && state["flavor"] == flavor_filter;
               });
            var max = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
            });
            var min = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
            });
            document.getElementById('min-value-p').innerHTML = min['index'];
            document.getElementById('max-value-p').innerHTML = max['index'];
            var range = max["index"] - min["index"];
            for(var i = 0; i < states.length; i++){
               if(states[i]["state"] != statename){
                  document.querySelector('[state-name="' + states[i]["state"] + '"]').style.cssText += 'fill: #ECFFDC';
               }
               else{
                  var ratio = (states[i]["index"] - min["index"]) / range;
                  var red = 100 + (222 - 100) * ratio;
                  var green = 149 - (149 - 49) * ratio;
                  var blue = 237 - (237 - 99) * ratio;
                  var color = "rgb(" + red + "," + green + "," + blue + ")";
                  document.querySelector('[state-name="' + states[i]["state"] + '"]').style.cssText += 'fill: ' + color + ';';
               }
            }
            
         }

        // Display historical max and min data
        function display_hist(data, name){
            var states = data[0].filter(state => {
                  return state["state"] == name && state["type"] == type_filter && state["index type"] == index_filter && state["flavor"] == flavor_filter;;
               });
               var max = states.reduce(function(prev, curr){
                  return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
               });
               var min = states.reduce(function(prev, curr){
                  return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
               });
               document.getElementById('hisMin').innerHTML = "<strong>Min:</strong> " + min['index'] + " (" + min['year'] + ")";
               document.getElementById('hisMax').innerHTML = "<strong>Max:</strong> " + max['index'] + " (" + max['year'] + ")";
        };

        // Check house type
        function typeCheckedOnClick(check){
            var checkboxes = document.getElementsByClassName("filter_type");
            for(var i = 0; i < checkboxes.length; i++){
               checkboxes.item(i).checked = false; // uncheck all checkboxes
            }
            type_filter = check.id;
            check.checked = true; // check the clicked checkbox
            if(curr_selection == "us"){
               display_color(csvData);
            }
            else{
               statename = document.getElementById("displayName").innerText.split(": ")[1];
               change_color(csvData, statename);
               display_hist(csvData, statename);
            }
            if (check.id == "non-metro"){
               var checkboxes = document.getElementsByClassName("filter_flavor");
                  for(var i = 0; i < checkboxes.length; i++){
                     checkboxes.item(i).disabled = true; // disable all checkboxes
               }
               var slider = document.getElementById("slider-range");
               if(slider.value < 1995){
                  year = 1995;
                  slider.setAttribute("value", 1995);  
                  show_value(year);
               }
               slider.setAttribute("min", 1995);
            }
            else{
               var checkboxes = document.getElementsByClassName("filter_flavor");
                  for(var i = 0; i < checkboxes.length; i++){
                     checkboxes.item(i).disabled = false; // disable all checkboxes
               }
               var slider = document.getElementById("slider-range");
               slider.setAttribute("min", 1971);
            }
            
        };

        // Check house flavor
        function flavorCheckedOnClick(check){
            var checkboxes = document.getElementsByClassName("filter_flavor");
            for(var i = 0; i < checkboxes.length; i++){
               checkboxes.item(i).checked = false; // uncheck all checkboxes
            }
            flavor_filter = check.id;
            check.checked = true; // check the clicked checkbox
            if(curr_selection == "us"){
               display_color(csvData);
            }
            else{
               statename = document.getElementById("displayName").innerText.split(": ")[1];
               change_color(csvData, statename);
               display_hist(csvData, statename);
            }
            if(check.id == "all-transactions"){
               var checkboxes = document.getElementsByClassName("filter_type");
                  for(var i = 0; i < checkboxes.length; i++){
                     checkboxes.item(i).disabled = false; // disable all checkboxes
               }
            }
            else{
               var checkboxes = document.getElementsByClassName("filter_type");
                  for(var i = 0; i < checkboxes.length; i++){
                     checkboxes.item(i).disabled = true; // disable all checkboxes
               }
            }
        };
         // Adjust year slider to change scope
         function show_value(value){
            document.getElementById("slider_value").innerHTML = value;  
            if(curr_selection == "us"){
               display_color(csvData);
            }
            else{
               statename = document.getElementById("displayName").innerText.split(": ")[1];
               change_color(csvData, statename);
            }
            
         };
    </script>
    <style>
    </style>
    <body>
        <div class = "container">
         <div class="page-title">
            <h1>United States House Price Index</h1>
         </div>
            <div class = "row align-items-start">
               <div class = "col" id="left-col">
                  <div style="margin-top:2em;">
                     <div class = "stat-rect">
                        <div class = "min-value">
                           <p id="min-value-p">0</p>
                        </div>
                        <div class = "max-value">
                           <p id="max-value-p">100</p>
                        </div>
                     </div>
                  </div>
                  <button class = "btn" id = "clearbtn">Back</button>
                  <div>
                     <script>
                        loadMap("usMap");
                     </script>
                  </div>
               </div>
               <div class = "col">
                  <div class="filter">
                     <div class = "filter-title" style="margin-bottom:-15px">
                        <p>YEAR</p>
                     </div>
                     <input type="range" id = "slider-range" class="form-range" min="1975" max="2022" step="1" value="2022" id="year-range" onchange=" year=this.value; show_value(this.value);">
                     <div style="text-align:center;">
                        <span id="slider_value" style="color:black;font-weight: bolder;">2022</span>
                     </div>
                  </div>
                  <div class="filter">
                     <div id="type-filter" style="margin-bottom:10px;">
                        <div class = "filter-title" style="margin-bottom:-15px;">
                           <p>House Types</p>
                        </div>
                        <div class="filter-value">
                           <input type="checkbox" checked class="filter_type" id="traditional" onclick="typeCheckedOnClick(this);"><p title="Traditional houses" style="display:inline; cursor:default;"> Traditional</p><br>
                           <input type="checkbox" class="filter_type" id= "non-metro" onclick="typeCheckedOnClick(this);"><p title = "Non-Metro houses are located in areas without the access to metro" style="display:inline; cursor:default;"> Non-Metro</p><br>
                        </div>
                     </div>
                     <div id ="flavor-filter">
                        <div class = "filter-title">
                           <p>Flavor</p>
                        </div>
                        <div class="filter-value">
                           <input type="checkbox" checked class="filter_flavor" id="all-transactions" onclick="flavorCheckedOnClick(this);"><p title= "Purchase-Only Index tracks mortgages used to purchase existing single-family homes" style = "display:inline; cursor:default;"> All-Transactions</p><br>
                           <input type="checkbox" class="filter_flavor" id="expanded-data" onclick="flavorCheckedOnClick(this);"><p title="Build on the purchase-only data by adding transcations from FHA and county recorder data" style="display:inline; cursor:default;"> Expanded-Data</p><br>
                           <input type="checkbox" class="filter_flavor" id="purchase-only" onclick="flavorCheckedOnClick(this);"><p title="All-Transactions indexes cover conventional and conforming mortgage transactions used to purchase or refinance an existing single-family home" style="display:inline; cursor:default;"> Purchase-Only</p><br>
                        </div>
                     </div>
                  </div>
   
                  <div class="display">
                     <div id="displayName">
                        <strong>States: </strong>
                     </div>
                     <div class = "index">
                        <div id="currentIdx"><strong>Current:</strong></div>
                        <div id="hisMax"><strong>Max:</strong></div>
                        <div id="hisMin"><strong>Min:</strong></div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
    </body>

</html>