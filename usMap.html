<!DOCTYPE html>
<html>
    <head>
         <link rel="stylesheet" href="style.css" type="text/css">
         <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
         <script src="https://d3js.org/d3.v6.min.js"></script>
         <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
         <script>
            function loadMap(mapName){
               $.getJSON('json/' + mapName + ".json", function(data){
                  var col = document.getElementById("left-col")
                  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                  for(var state of Object.keys(data.paths)){
                     const path = document.createElementNS("http://www.w3.org/2000/svg","path");
                     path.setAttribute('id', 'state-map');
                     path.setAttribute('data-name', state);
                     path.setAttribute('d', data.paths[state]);
                     svg.appendChild(path);
                  }
                  col.appendChild(svg);
                  svg.setAttribute('viewBox', data.viewBox);
                  svg.setAttribute('width', data.width);
                  svg.setAttribute('height', data.height);
                  svg.setAttribute('id', data.id);
               });
            }
         </script>
    </head>
    <body>
      <div class = "container">
         <div class = "row align-items-start">
            <div class = "col" id="left-col">
               <div style="margin-top:2em;">
                  <div class = "stat-rect">
                     <div class = "min-value">
                        <p id="min-value-p">0</p>
                     </div>
                     <div class = "max-value">
                        <p id="max-value-p">100</p>
                     </div>
                  </div>
               </div>
               <button class = "btn" id = "clearbtn">Clear</button>
               <div>
                  <script>
                     loadMap("us");
                  </script>
               </div>
            </div>
            <div class = "col">
               <div class="filter">
                  <div class = "filter-title" style="margin-bottom:-15px">
                     <p>YEAR</p>
                  </div>
                  <input type="range" class="form-range" min="1991" max="2022" step="1" value="2022" id="year-range" onchange=" year=this.value; show_value(this.value);">
                  <div style="text-align:center;">
                     <span id="slider_value" style="color:black;font-weight: bolder;">2022</span>
                  </div>
               </div>
               <div class="filter">
                  <div id="type-filter" style="margin-bottom:10px;">
                     <div class = "filter-title" style="margin-bottom:-15px;">
                        <p>House Types</p>
                     </div>
                     <div class="filter-value">
                        <input type="checkbox" checked class="filter_value" id="traditional" onclick="valueCheckedOnClick(this);"><p title="Traditional houses" style="display:inline; cursor:default;"> Traditional</p><br>
                        <input type="checkbox" class="filter_value" id= "non-metro" onclick="valueCheckedOnClick(this);"><p  title = "Non-Metro houses are located in areas without the access to metro" style="display:inline; cursor:default;"> Non-Metro</p><br>
                     </div>
                  </div>
                  <div id ="flavor-filter">
                     <div class = "filter-title">
                        <p>Flavor</p>
                     </div>
                     <div class="filter-value">
                        <input type="checkbox" checked class="filter_flavor" id="all-transactions" onclick="flavorCheckedOnClick(this);"><p title= "Purchase-Only Index tracks mortgages used to purchase existing single-family homes" style = "display:inline; cursor:default;"> All-Transactions</p><br>
                        <input type="checkbox" class="filter_flavor" id="expanded-data" onclick="flavorCheckedOnClick(this);"><p title="Build on the purchase-only data by adding transcations from FHA and county recorder data" style="display:inline; cursor:default;"> Expanded-Data</p><br>
                        <input type="checkbox" class="filter_flavor" id="purchase-only" onclick="flavorCheckedOnClick(this);"><p title="All-Transactions indexes cover conventional and conforming mortgage transactions used to purchase or refinance an existing single-family home" style="display:inline; cursor:default;"> Purchase-Only</p><br>
                     </div>
                  </div>
               </div>

               <div class="display">
                  <div id="displayName">
                     <strong>States: </strong>
                  </div>
                  <div class = "index">
                     <div id="currentIdx"><strong>Current:</strong></div>
                     <div id="hisMax"><strong>Max:</strong></div>
                     <div id="hisMin"><strong>Min:</strong></div>
                  </div>
               </div>
            </div>
         </div>
      </div>
         <script>
            let allowhover = true;
            var csvData;
            var stateName;
            var year = 2022;
            var type_filter = "traditional";
            var index_filter = "index_nsa";
            var flavor_filter = "all-transactions";
            Promise.all([
               d3.csv('datasets/states_cleaned_data.csv')
            ]).then(ready);
            function ready(data){
               csvData = data;
               display_color(data);
               // Mouse Hover Over State Show Stats
               document.addEventListener('mouseover', function(event){
                  let name = event.target.getAttribute('data-name');
                  if(name != null && allowhover){
                     stateName = name;
                     display_color(data);
                     event.target.style.cssText += 'fill: #FCF55F;';
                     document.getElementById('displayName').innerHTML = "<strong>States: </strong>" + name;
                     var result = data[0].filter(obj => {
                        return obj["state"] === name && obj["year"] == year && obj["type"] == type_filter && obj["index type"] == index_filter && obj["flavor"] == flavor_filter;
                     });
                     display_hist(data, stateName);
                     document.getElementById('currentIdx').innerHTML = "<strong>Current: </strong>" + result[0]["index"];
                  }
                  else{
                     if(allowhover){
                        display_color(data);
                        document.getElementById('displayName').innerHTML = "<strong>States: </strong>";
                        document.getElementById('currentIdx').innerHTML = "<strong>Current: </strong>";
                        document.getElementById('hisMax').innerHTML = "<strong>Max: </strong>";
                        document.getElementById('hisMin').innerHTML = "<strong>Min: </strong>";
                     }
                  }
               });
               // Mouse Click on State Show Stats
               document.addEventListener('click', function(event){
                  let name = event.target.getAttribute('data-name');
                  if(name != null){
                        var states = document.querySelectorAll("[id^='state-map']");
                        stateName = name;
                        display_color(data);
                        event.target.style.cssText += 'fill: #FCF55F;';
                        var result = data[0].filter(obj => {
                           return obj["state"] == name && obj["year"] == year && obj["type"] == type_filter && obj["index type"] == index_filter && obj["flavor"] == flavor_filter;
                        });
                        display_hist(data, stateName);
                        console.log(result);
                        document.getElementById('currentIdx').innerHTML = "<strong>Current: </strong>" + result[0]["index"];
                        document.getElementById('displayName').innerHTML = "<strong>States: </strong>" + event.target.getAttribute('data-name');
                        allowhover = false;
                  }
               }); 
               // Clear Btn
               document.getElementById("clearbtn").onclick = function(){clear()};
               function clear(){
                  var states = document.querySelectorAll("[id^='state-map']");
                  for (var i = 0; i < states.length; i++) {
                     states[i].style.fill = "";
                  }
                  allowhover = true;
                  document.getElementById('displayName').innerHTML = "<strong>States: </strong>";
                  document.getElementById('currentIdx').innerHTML = "<strong>Current: </strong>";
                  document.getElementById('hisMax').innerHTML = "<strong>Max: </strong>";
                  document.getElementById('hisMin').innerHTML = "<strong>Min: </strong>";
                  display_color(data);
               };
            };
            function show_value(x){
               document.getElementById("slider_value").innerHTML=x;
               display_color(csvData);
            };
            function display_color(data){
               var states = data[0].filter(state => {
                  return state["year"] == year && state["type"] == type_filter && state["index type"] == index_filter && state["flavor"] == flavor_filter;
               });
               var max = states.reduce(function(prev, curr){
                  return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
               });
               var min = states.reduce(function(prev, curr){
                  return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
               });
               var range = max["index"] - min["index"];
               document.getElementById('min-value-p').innerHTML = min['index'];
               document.getElementById('max-value-p').innerHTML = max['index'];
               for(var i = 0; i < states.length; i++){
                  var ratio = (states[i]["index"] - min["index"]) / range;
                  // Predefined RGB color scale
                  // Red = 222 - 100
                  // Green = 149 - 49
                  // Blue = 237 - 99
                  var red = 100 + (222 - 100) * ratio;
                  var green = 149 - (149 - 49) * ratio;
                  var blue = 237 - (237 - 99) * ratio;
                  var color = "rgb(" + red + "," + green + "," + blue + ")";
                  document.querySelector('[data-name="' + states[i]["state"] + '"]').style.cssText += 'fill: ' + color + ';';
               }
            }
            function display_hist(data, stateName){
               var states = data[0].filter(state => {
                  return state["state"] == stateName && state["type"] == type_filter && state["index type"] == index_filter && state["flavor"] == flavor_filter;;
               });
               var max = states.reduce(function(prev, curr){
                  return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
               });
               var min = states.reduce(function(prev, curr){
                  return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
               });
               document.getElementById('hisMin').innerHTML = "<strong>Min:</strong> " + min['index'] + " (" + min['year'] + ")";
               document.getElementById('hisMax').innerHTML = "<strong>Max:</strong> " + max['index'] + " (" + max['year'] + ")";
            };
            
         </script>
         <script>
            function valueCheckedOnClick(check){
               // Select all checkboxes by class
               var checkboxesList = document.getElementsByClassName("filter_value");
               for (var i = 0; i < checkboxesList.length; i++) {
                  checkboxesList.item(i).checked = false; // Uncheck all checkboxes
               }
               type_filter = check.id;
               check.checked = true; // Checked clicked checkbox
               display_color(csvData);
            }
            function flavorCheckedOnClick(check){
               var checkboxesList = document.getElementsByClassName("filter_flavor");
               for (var i = 0; i < checkboxesList.length; i++) {
                  checkboxesList.item(i).checked = false; // Uncheck all checkboxes
               }
               flavor_filter = check.id;
               check.checked = true; // Checked clicked checkbox
               display_color(csvData);
            }
         </script>
         <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js"></script>
         <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
   </body>
</html>